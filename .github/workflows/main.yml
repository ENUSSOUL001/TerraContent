name: Generate Documentation
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-documentation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Unpack Archive
        run: |
          # Failsafe check to make sure the zip exists before trying to unzip
          if [ -f "claude-code-router-main.zip" ]; then
            unzip -o claude-code-router-main.zip
          else
            echo "Error: claude-code-router-main.zip not found."
            exit 1
          fi

      - name: Consolidate All Readable Files
        run: |
          OUTPUT_FILE="claude_documentation.md"
          SOURCE_DIR="claude-code-router-main"
          
          echo "# Documentation for ${SOURCE_DIR}" > $OUTPUT_FILE
          echo "" >> $OUTPUT_FILE

          # This is a simple, powerful, and reliable command to find all files recursively.
          # It then pipes that list to a loop.
          find "$SOURCE_DIR" -type f | sort | while read -r file; do
            
            # This is the correct way to check if a file is text-based.
            # It checks the file's content, not its name. It will find .json, .md,
            # .yml, .ts, Dockerfile, LICENSE, and any other readable text file.
            if file -b --mime-type "$file" | grep -q "text"; then
              echo "âœ… Combining: $file"
              echo "---" >> $OUTPUT_FILE
              echo "## File: \`$file\`" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              echo '```' >> $OUTPUT_FILE
              cat "$file" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              echo '```' >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
            else
              # It will correctly identify and skip binary files like images.
              echo "Skipping binary file: $file"
            fi
          done

      - name: Commit Documentation File
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add claude_documentation.md
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "docs: Generate documentation for claude-code-router"
            git push
          else
            echo "No changes to the documentation file."
          fi
