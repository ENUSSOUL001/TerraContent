name: TerraAWG Runner
on:
  workflow_dispatch:
    inputs:
      name:
        description: 'World Name (use RANDOM for a random name)'
        required: true
        type: string
        default: 'Terra AWG World'
      seed:
        description: 'World Seed (use RANDOM for a random seed)'
        required: true
        type: string
        default: 'RANDOM'
      size:
        description: 'Select a world size'
        required: true
        type: choice
        options:
        - Extra Small
        - Small
        - Medium
        - Large
        - Extra Large
        default: 'Medium'
      evil:
        description: 'Select the world evil'
        required: true
        type: choice
        options: [RANDOM, corruption, crimson]
        default: 'RANDOM'
      hardmode_options:
        description: 'Select a Hardmode option'
        required: true
        type: choice
        options:
        - Disabled
        - Enabled
        - Enabled (with Hardmode Loot)
        default: 'Disabled'
      doubleTrouble:
        description: '[World Option] Drunk World (both evils/ores)'
        type: boolean
        default: false
      shattered:
        description: '[World Option] Shattered world into floating islands'
        type: boolean
        default: false
      sunken:
        description: '[World Option] Sunken world (flooded surface)'
        type: boolean
        default: false
      purity:
        description: '[World Option] Pure world (no spreading biomes)'
        type: boolean
        default: false
      forTheWorthy:
        description: '[World Option] For The Worthy effects'
        type: boolean
        default: false
      noTraps:
        description: '[World Option] No Traps seed effects'
        type: boolean
        default: false

jobs:
  generate-world:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Generate config file from inputs
        shell: pwsh
        run: |
          # --- Translate User-Friendly Inputs to INI values ---
          $width = 6400; $height = 1800 # Default to Medium
          switch ("${{ github.event.inputs.size }}") {
            "Extra Small" { $width = 2100; $height = 600 }
            "Small"       { $width = 4200; $height = 1200 }
            "Medium"      { $width = 6400; $height = 1800 }
            "Large"       { $width = 8400; $height = 2400 }
            "Extra Large" { $width = 12600; $height = 3600 }
          }

          $hardmode = "false"; $hardmodeLoot = "false"
          switch ("${{ github.event.inputs.hardmode_options }}") {
            "Enabled" { $hardmode = "true" }
            "Enabled (with Hardmode Loot)" { $hardmode = "true"; $hardmodeLoot = "true" }
          }
          
          $traps = 1.0
          if ("${{ github.event.inputs.noTraps }}" -eq "true") {
            $traps = 15.0
          }

          # --- Build the INI content ---
          $iniContent = @"
          [world]
          name = ${{ github.event.inputs.name }}
          seed = ${{ github.event.inputs.seed }}
          width = $width
          height = $height
          mode = classic
          evil = ${{ github.event.inputs.evil }}
          home = false
          [variation]
          equipment = none
          doubleTrouble = ${{ github.event.inputs.doubleTrouble }}
          shattered = ${{ github.event.inputs.shattered }}
          sunken = ${{ github.event.inputs.sunken }}
          purity = ${{ github.event.inputs.purity }}
          hardmode = $hardmode
          hardmodeLoot = $hardmodeLoot
          patches = false
          forTheWorthy = ${{ github.event.inputs.forTheWorthy }}
          traps = $traps
          [extra]
          map = true
          "@
          Set-Content -Path "Terra/terra-awg.ini" -Value $iniContent
          echo "--- terra-awg.ini created ---"
          Get-Content -Path "Terra/terra-awg.ini"

      - name: Run World Generator
        shell: pwsh
        run: |
          cd Terra
          echo "--- Running Terra AWG ---"
          ./terra-awg.exe
          echo "--- World generation complete. ---"
          cd ..
      
      - name: Upload Generated Files as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: generated-world-files
          path: |
            Terra/*.wld
            Terra/*.png
          if-no-files-found: error
